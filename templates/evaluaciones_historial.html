<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Evaluaciones - Tres en Raya IA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS desde CDN para diseño responsivo -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  
  <!-- Hoja de estilos personalizada -->
  <link rel="stylesheet" href="/static/css/historial.css" />

  <!-- Librería Chart.js para gráficos (Radar) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- Botón para volver a la página de evaluación -->
  <button class="btn-back" onclick="window.location.href='/evaluar'">← Regresar</button>

  <div class="container">
    <!-- Título principal -->
    <h1>Historial de Evaluaciones</h1>

    <!-- Botón para mostrar u ocultar la rúbrica de evaluación -->
    <button class="btn btn-outline-secondary rubrica-toggle-btn" onclick="toggleRubrica()">Ver Rúbrica</button>

    <!-- Botón para volver a evaluar -->
    <a href="/evaluar" class="btn btn-primary mb-3">Volver a evaluar</a>

    <!-- Campo de texto para filtrar por jugador o modelo -->
    <input type="text" id="filtro" class="form-control mb-3" placeholder="Buscar por modelo o jugador..." />

    <!-- Tabla responsiva que contiene el historial de evaluaciones -->
    <div class="table-responsive">
      <table class="table table-bordered align-middle table-striped" role="table" aria-label="Historial de evaluaciones">
        <thead class="table-dark text-center">
          <tr>
            <th>Fecha</th>
            <th>Jugador</th>
            <th>Modelo</th>
            <th>Movimiento</th>
            <th>Evaluación</th>
            <th>Razón y Tablero</th>
          </tr>
        </thead>
        <tbody>
          <!-- Iteración sobre cada evaluación enviada por Flask -->
          {% for ev in evaluaciones %}
          <tr>
            <td>{{ ev.timestamp }}</td>
            <td>{{ ev.jugador | upper }}</td>
            <td>{{ ev.modelo }}</td>
            <td>{{ ev.movimiento_legible }}</td>
            <td class="text-center">
              <!-- Etiqueta visual con color según tipo de evaluación -->
              <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="badge badge-eval
                    {% if ev.evaluacion == 'Buena' %}badge-Buena
                    {% elif ev.evaluacion == 'Mala' %}badge-Mala
                    {% elif ev.evaluacion == 'Creativa' %}badge-Creativa
                    {% else %}badge-Pudo{% endif %}" 
                    title="{% if ev.evaluacion == 'Buena' %}Buena: movimiento estratégico y correcto
                          {% elif ev.evaluacion == 'Mala' %}Mala: movimiento erróneo o sin sentido
                          {% elif ev.evaluacion == 'Creativa' %}Creativa: movimiento original o inesperado
                          {% else %}Puede mejorar: movimiento válido pero con errores
                          {% endif %}">
                  {{ ev.evaluacion }}
                </span>
              </div>
            </td>
            <td>
              <!-- Contenedor de la explicación y tablero -->
              <div class="razon-tablero">
                <!-- Texto con la razón de la evaluación -->
                <pre>{{ ev.razon_texto or "Sin explicación" }}</pre>

                <!-- Renderizado del tablero, ya sea string o lista -->
                {% if ev.tablero is string %}
                <pre>{{ ev.tablero }}</pre>
                {% else %}
                <div class="tablero-mini">
                  {% for fila in ev.tablero %}
                  <div>
                    {% for celda in fila %}
                    <span>{{ celda if celda != 'b' else '-' }}</span>
                    {% endfor %}
                  </div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </td>
          </tr>
          {% else %}
          <!-- Mensaje por defecto si no hay evaluaciones -->
          <tr>
            <td colspan="6" class="text-center fst-italic">No hay evaluaciones aún.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Gráfico tipo radar con promedios por dimensión -->
    <div id="radarContainer" aria-label="Gráfico radar resumen de evaluaciones">
      <h2>Resumen Promedio por Dimensión</h2>
      <canvas id="graficoRadar" aria-label="Gráfico radar evaluaciones" role="img"></canvas>
    </div>
  </div>

  <!-- Panel lateral oculto que muestra la rúbrica de evaluación -->
  <div id="rubricaPanel" aria-hidden="true" role="region" aria-label="Rúbrica de evaluación">
    <h3>Rúbrica de Evaluación</h3>
    <div id="rubricaContent">
      <!-- Rúbrica con 7 dimensiones evaluativas -->
      {% for r in [
        ("Comprensión de Reglas", "Viola reglas básicas: casilla ocupada o fuera del tablero.", "Cumple reglas básicas, pero omite situaciones menos evidentes.", "Siempre movimientos legales, respeta todas las reglas del turno."),
        ("Validez y Legalidad", "Movimiento inválido o ilegal.", "Movimiento válido sin análisis profundo.", "Válido y elegido tras un análisis completo."),
        ("Razonamiento Estratégico", "Acción sin lógica.", "Intención simple (bloquear/avanzar), sin anticipación.", "Justificación clara, anticipa jugadas."),
        ("Factualidad", "Incorrecta o no relacionada con tablero.", "Generalmente correcta con imprecisiones.", "Precisa y basada en hechos concretos."),
        ("Coherencia Explicativa", "Confusa o contradictoria.", "Clara pero superficial.", "Lógica, completa y coherente."),
        ("Claridad Lingüística", "Lenguaje poco claro.", "Claro con errores menores.", "Preciso, correcto y comprensible."),
        ("Adaptabilidad", "Ignora cambios previos.", "Se adapta de forma básica o tardía.", "Rápida adaptación y ajuste efectivo.")
      ] %}
      <div class="rubrica-entry">
        <h5>{{ r[0] }}</h5>
        <p><strong>1:</strong> {{ r[1] }}</p>
        <p><strong>2:</strong> {{ r[2] }}</p>
        <p><strong>3:</strong> {{ r[3] }}</p>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Variables globales pasadas desde Flask para uso en JS -->
  <script>
    window.dimensiones = {{ dimensiones | tojson }};  // Nombres de las dimensiones
    window.promedios = {{ promedios | tojson }};      // Promedios por dimensión
  </script>

  <!-- Script principal de funcionalidades JS (gráfico, filtro, etc.) -->
  <script src="/static/js/historial.js"></script>

  <!-- Script Bootstrap JS para funcionalidades interactivas -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
