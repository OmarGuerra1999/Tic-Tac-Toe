<!DOCTYPE html> <!-- Declaraci√≥n del tipo de documento HTML5 -->
<html lang="es"> <!-- Indica que el contenido est√° en espa√±ol -->
  <head>
    <meta charset="UTF-8" /> <!-- Codificaci√≥n de caracteres en UTF-8 -->
    <title>Evaluar √öltima Jugada - Tres en Raya IA</title> <!-- T√≠tulo que aparece en la pesta√±a del navegador -->
    <meta name="viewport" content="width=device-width, initial-scale=1" /> <!-- Configura la escala para dise√±o responsivo en dispositivos m√≥viles -->

    <!-- Inclusi√≥n de la hoja de estilos de Bootstrap para estilos y componentes responsivos -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Enlace a la hoja de estilos personalizada del proyecto -->
    <link rel="stylesheet" href="/static/css/evaluar.css" />
  </head>
  <body>
    <!-- Bot√≥n que redirige al usuario a la p√°gina de inicio -->
    <button
      class="btn btn-secondary btn-back"
      onclick="window.location.href='/'"
    >
      ‚Üê Inicio
    </button>

    <!-- Bot√≥n que permite mostrar u ocultar la r√∫brica lateral -->
    <button class="btn btn-outline-info rubrica-btn" onclick="toggleRubrica()">
      üìò Ver R√∫brica
    </button>

    <!-- Panel lateral ocultable que contiene la r√∫brica de evaluaci√≥n -->
    <div class="rubrica-panel" id="rubricaPanel">
      <!-- Bot√≥n para cerrar el panel de la r√∫brica -->
      <button class="btn btn-sm btn-light btn-close" onclick="toggleRubrica()">
        ‚úï
      </button>
      <h2>R√∫brica de Evaluaci√≥n</h2>

      <!-- Tabla con los criterios de evaluaci√≥n, divididos por dimensiones y niveles -->
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Dimensi√≥n</th> <!-- Categor√≠a a evaluar -->
            <th>Nivel 1</th> <!-- Nivel bajo -->
            <th>Nivel 2</th> <!-- Nivel medio -->
            <th>Nivel 3</th> <!-- Nivel alto -->
          </tr>
        </thead>
        <tbody>
          <!-- Cada fila representa una dimensi√≥n de evaluaci√≥n y sus descripciones para cada nivel -->
          <tr>
            <td>Comprensi√≥n de Reglas</td>
            <td>Viola reglas b√°sicas</td>
            <td>Cumple reglas b√°sicas</td>
            <td>Siempre legal</td>
          </tr>
          <tr>
            <td>Validez y Legalidad</td>
            <td>Movimiento inv√°lido</td>
            <td>V√°lido, sin an√°lisis</td>
            <td>V√°lido y analizado</td>
          </tr>
          <tr>
            <td>Razonamiento Estrat√©gico</td>
            <td>Sin l√≥gica</td>
            <td>Intenci√≥n simple</td>
            <td>Justificaci√≥n anticipada</td>
          </tr>
          <tr>
            <td>Factualidad</td>
            <td>Explicaci√≥n incorrecta</td>
            <td>Correcta, imprecisa</td>
            <td>Basada en hechos concretos</td>
          </tr>
          <tr>
            <td>Coherencia Explicativa</td>
            <td>Confusa</td>
            <td>Clara pero superficial</td>
            <td>L√≥gica y completa</td>
          </tr>
          <tr>
            <td>Claridad Ling√º√≠stica</td>
            <td>Errores graves</td>
            <td>Peque√±os errores</td>
            <td>Gram√°tica precisa</td>
          </tr>
          <tr>
            <td>Adaptabilidad</td>
            <td>Ignora jugada previa</td>
            <td>Adaptaci√≥n b√°sica</td>
            <td>Se adapta eficazmente</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="container"> <!-- Contenedor principal de la p√°gina -->
      <h1>Evaluar √öltima Jugada</h1>

      {% if jugada %} <!-- Verifica si hay una jugada disponible para evaluar -->

      <!-- Texto informativo sobre la jugada actual -->
      <p class="text-center fw-semibold mb-3" style="font-size: 1.2rem">
        √öltima jugada.
      </p>

      <!-- Contenedor donde se renderiza visualmente el tablero del juego -->
      <div id="tablero-dinamico" class="mt-3 mb-3"></div>

      <!-- Secci√≥n donde se mostrar√° informaci√≥n din√°mica sobre la jugada -->
      <div
        id="info-jugada"
        aria-live="polite"
        style="margin-top: 1rem; font-size: 1.2rem"
        class="mb-4 mt-4 text-center"
      >
        INFO DE LA JUGADA: Cargando...
      </div>

      <!-- Formulario que permite evaluar la jugada mediante una r√∫brica -->
      <div class="d-flex gap-3 flex-wrap">
        <form
          id="evaluationForm" action="/guardar_evaluacion"
          method="POST" <!-- M√©todo HTTP utilizado -->
          class="flex-grow-1"
          style="font-size: 1.2rem"
         >
          <!-- Campos ocultos que contienen los datos de la jugada actual -->
          <input type="hidden" name="match_id" value="{{ jugada.match_id }}" />
          <input type="hidden" name="jugador" value="{{ jugada.jugador }}" />
          <input type="hidden" name="modelo" value="{{ jugada.modelo }}" />
          <input
            type="hidden"
            name="movimiento"
            value="{{ jugada.movimiento | tojson | safe }}"
          />

          <h4 class="mb-3">Evaluaci√≥n por R√∫brica</h4>

          <!-- Definici√≥n de las dimensiones a evaluar con sus respectivas descripciones -->

          {% for nombre, descripcion in dimensiones %} <!-- Bucle que renderiza cada dimensi√≥n -->
          <div class="mb-4">
            <label class="form-label fw-bold">{{ nombre }}</label> <!-- Nombre de la dimensi√≥n -->
            <p class="text-muted">{{ descripcion }}</p> <!-- Descripci√≥n explicativa -->

            <!-- Opciones de radio para seleccionar el nivel de evaluaci√≥n (1, 2 o 3) -->
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="rubrica[{{ nombre }}]"
                value="1"
                required
              />
              <label class="form-check-label">1 - Bajo</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="rubrica[{{ nombre }}]"
                value="2"
              />
              <label class="form-check-label">2 - Medio</label>
            </div>
            <div class="form-check form-check-inline">
              <input
                class="form-check-input"
                type="radio"
                name="rubrica[{{ nombre }}]"
                value="3"
              />
              <label class="form-check-label">3 - Alto</label>
            </div>
          </div>
          {% endfor %}

          <!-- √Årea de texto para que el usuario escriba su justificaci√≥n de la evaluaci√≥n -->
          <div class="mb-3">
            <label for="razon" class="form-label fw-bold">
              Explicaci√≥n general de la evaluaci√≥n
            </label>
            <textarea
              name="razon"
              id="razon"
              class="form-control"
              rows="4"
              style="font-size: 1.1rem"
              placeholder="Escribe una justificaci√≥n completa..."
            ></textarea>
          </div>

          <!-- Bot√≥n para enviar el formulario y guardar la evaluaci√≥n -->
          <button type="submit" class="btn btn-success btn-lg w-100">
            ‚úÖ Guardar Evaluaci√≥n
          </button>
        </form>
      </div>

      <!-- Enlace que redirige al historial de evaluaciones previas -->
      <a href="/evaluaciones_historial" class="btn-history mt-4" style="font-size: 1.2rem;">
        üìú Ver historial de evaluaciones
      </a>

      {% else %} <!-- Si no hay jugadas disponibles para evaluar -->
      <p class="text-center fs-5 mt-5">
        No hay jugadas para evaluar a√∫n. Juega primero para generar jugadas.
      </p>
      {% endif %}
    </div>

    <!-- Script JavaScript del proyecto que maneja l√≥gica din√°mica de evaluaci√≥n -->
    <script src="/static/js/evaluar.js"></script>

    <!-- Script de Bootstrap que activa funcionalidades din√°micas como modales, tooltips, etc. -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  #############################################################################
    <script src="/static/js/evaluar.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('evaluationForm');
            const saveBtn = document.getElementById('saveEvaluationBtn');

            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    // Validar formulario (si quitaste el onsubmit, puedes copiar la l√≥gica aqu√≠)
                    // Por ahora, solo enviaremos
                    
                    // Recoger los datos del formulario
                    const formData = new FormData(form);
                    const queryParams = new URLSearchParams();
                    const rubricaData = {};

                    for (const [key, value] of formData.entries()) {
                        // Flask recibe 'rubrica[Dimensi√≥n]' directamente.
                        // Para FormData y fetch, necesitamos reconstruirlo para que Flask lo interprete correctamente.
                        // Si quieres enviar como application/x-www-form-urlencoded
                        // Flask request.form ya lo parsea correctamente de FormData.
                        // El problema es si se est√° volviendo a GET.

                        // Si tienes la validaci√≥n, ponla aqu√≠
                        // if (!validarFormulario()) { // Si validarFormulario sigue existiendo
                        //    return; // Detiene el env√≠o
                        // }

                        // Para simular la estructura de URL con los rubrica[dimension]
                        // vamos a pasar los datos como un objeto para fetch.
                        // Pero para un POST normal con FormData, Flask ya lo maneja bien.
                        // El objetivo aqu√≠ es simplemente forzar el m√©todo.
                    }

                    fetch(form.action, {
                        method: 'POST', // FORZAMOS EXPLICITAMENTE EL M√âTODO POST
                        body: formData // Enviamos los datos del formulario
                    })
                    .then(response => {
                        console.log('Respuesta del servidor:', response);
                        if (response.ok) { // Si la respuesta fue exitosa (200-299)
                            alert('Evaluaci√≥n guardada con √©xito (POST forzado)');
                            window.location.href = '/evaluar'; // Redirige de vuelta
                        } else if (response.status === 405) {
                            alert('Error 405: M√©todo no permitido (¬°Todav√≠a GET! Hay un problema grave)');
                            // Si esto sigue siendo 405 aqu√≠, el problema es a√∫n m√°s profundo.
                        } else {
                            alert(`Error al guardar la evaluaci√≥n: ${response.status} ${response.statusText}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error de red al guardar evaluaci√≥n:', error);
                        alert('Error de red al guardar la evaluaci√≥n.');
                    });
                });
            }
        });
    </script>
    </body>
</html>
